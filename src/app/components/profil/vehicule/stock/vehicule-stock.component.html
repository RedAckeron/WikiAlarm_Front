<div class="vehicle-container">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="pi pi-box text-primary"></i>
        Stock du véhicule
      </h5>
      <button pButton 
              type="button" 
              icon="pi pi-plus" 
              label="Ajouter un article"
              class="p-button-success p-button-sm"
              (click)="onAddItem()"></button>
    </div>

    <div class="card-body">
      <!-- État de chargement -->
      <div *ngIf="loading" class="loading-state text-center p-4">
        <p-progressSpinner></p-progressSpinner>
        <p class="mt-3">Chargement du stock...</p>
      </div>

      <!-- Message si aucun article -->
      <div *ngIf="!loading && stockItems.length === 0" class="alert alert-info text-center p-4">
        <i class="pi pi-info-circle" style="font-size: 2rem;"></i>
        <p class="mt-3">Aucun article dans le stock de ce véhicule.</p>
      </div>

      <!-- Tableau du stock -->
      <div *ngIf="!loading && stockItems.length > 0">
        <p-table [value]="stockItems" 
                 styleClass="p-datatable-striped p-datatable-sm compact-table">
          <ng-template pTemplate="header">
            <tr>
              <th>Référence</th>
              <th>Nom</th>
              <th style="width: 80px" class="text-center">Quantité</th>
              <th style="width: 60px" class="text-center">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td class="reference-cell">{{item.Label}}</td>
              <td>{{item.Name}}</td>
              <td class="text-center">{{item.Qt}}</td>
              <td class="text-center p-0">
                <button pButton 
                        type="button" 
                        icon="pi pi-minus" 
                        class="p-button-danger p-button-sm p-button-rounded"
                        (click)="onRetireItem(item)"
                        [disabled]="item.Qt <= 0"
                        pTooltip="Retirer du stock"></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<!-- Dialog d'ajout -->
<p-dialog header="Ajouter un article" 
          [(visible)]="displayAddDialog" 
          [modal]="true" 
          [style]="{width: '450px'}" 
          [draggable]="false" 
          [resizable]="false">
  <div class="p-fluid">
    <div class="field mb-3">
      <label for="type">Type de matériel</label>
      <p-dropdown id="type"
                  [options]="materialTypes" 
                  [(ngModel)]="selectedType" 
                  [showClear]="true"
                  optionLabel="Name"
                  placeholder="Sélectionnez un type"
                  (onChange)="onTypeChange($event)">
        <ng-template let-type pTemplate="item">
          <div class="type-item">{{type.Name}}</div>
        </ng-template>
      </p-dropdown>
    </div>

    <div class="field mb-3">
      <label for="item">Article</label>
      <p-dropdown id="item"
                  [options]="filteredItems" 
                  [(ngModel)]="selectedItem" 
                  optionLabel="Name"
                  placeholder="Sélectionnez un article"
                  [disabled]="!selectedType">
        <ng-template let-item pTemplate="item">
          <div class="item-info">
            <div class="item-name">{{item.Name}}</div>
            <div class="item-description text-muted" *ngIf="item.Description">{{item.Description}}</div>
          </div>
        </ng-template>
      </p-dropdown>
    </div>

    <div class="field mb-3">
      <label for="quantity">Quantité</label>
      <p-inputNumber id="quantity" 
                     [(ngModel)]="addQuantity" 
                     [showButtons]="true" 
                     [min]="1" 
                     buttonLayout="horizontal"
                     spinnerMode="horizontal"
                     [step]="1"
                     decrementButtonClass="p-button-secondary"
                     incrementButtonClass="p-button-secondary"
                     incrementButtonIcon="pi pi-plus"
                     decrementButtonIcon="pi pi-minus"></p-inputNumber>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton type="button" 
            label="Annuler" 
            icon="pi pi-times" 
            class="p-button-text" 
            (click)="onCancelAdd()"></button>
    <button pButton type="button" 
            label="Ajouter" 
            icon="pi pi-check" 
            class="p-button-success" 
            (click)="onConfirmAdd()"
            [disabled]="!selectedItem || addQuantity <= 0"></button>
  </ng-template>
</p-dialog>

<!-- Dialog d'historique -->
<p-dialog header="Historique des mouvements" 
          [(visible)]="displayHistoryDialog" 
          [modal]="true" 
          [style]="{width: '800px'}" 
          [draggable]="false" 
          [resizable]="false">
  <p-table [value]="stockHistory" 
           [tableStyle]="{ 'min-width': '50rem' }"
           styleClass="p-datatable-striped">
    <ng-template pTemplate="header">
      <tr>
        <th>Date</th>
        <th>Article</th>
        <th>Quantité</th>
        <th>Type</th>
        <th>Client</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-history>
      <tr>
        <td>{{history.Date | date:'dd/MM/yyyy HH:mm'}}</td>
        <td>{{history.Label}}</td>
        <td class="text-center">{{history.Qt}}</td>
        <td>
          <span [class]="history.Type === 'ajout' ? 'status-badge status-success' : 'status-badge status-danger'">
            {{history.Type === 'ajout' ? 'Ajout' : 'Retrait'}}
          </span>
        </td>
        <td>{{history.ClientName || '-'}}</td>
      </tr>
    </ng-template>
  </p-table>

  <ng-template pTemplate="footer">
    <button pButton type="button" 
            label="Fermer" 
            icon="pi pi-times" 
            class="p-button-secondary" 
            (click)="onCloseHistory()"></button>
  </ng-template>
</p-dialog>

<p-toast></p-toast> 